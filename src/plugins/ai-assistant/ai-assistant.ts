/*!
 * Jodit Editor (https://xdsoft.net/jodit/)
 * Released under MIT see LICENSE.txt in the project root for license information.
 * Copyright (c) 2013-2024 Valeriy Chupurnov. All rights reserved. https://xdsoft.net
 */

/**
 * [[include:plugins/ai-assistant/README.md]]
 * @packageDocumentation
 * @module plugins/ai-assistant
 */

import type { IJodit } from 'jodit/types';
import watch from 'jodit/core/decorators/watch/watch';
import { extendLang, pluginSystem } from 'jodit/core/global';
import { Plugin } from 'jodit/core/plugin/plugin';

import './config';

import { UiAiAssistant } from './ui/ui-ai-assistant';
import * as langs from './langs';

/**
 * The plugin inserts content generated by AI into the editor.
 */
export class aiAssistant extends Plugin {
	/** @override */
	override buttons: Plugin['buttons'] = [
		{
			name: 'ai-commands',
			group: 'insert'
		},
		{
			name: 'ai-assistant',
			group: 'insert'
		}
	];

	constructor(jodit: IJodit) {
		super(jodit);
		extendLang(langs);
	}

	/** @override */
	override afterInit(jodit: IJodit): void {}

	@watch(':generateAiAssistantForm.ai-assistant')
	protected onGenerateAiAssistantForm(prompt: string): void {
		const { jodit } = this;

		const dialog = jodit.dlg({
			buttons: ['fullsize', 'dialog.close'],
			closeOnClickOverlay: true,
			closeOnEsc: true,
			resizable: false,
			draggable: true,
			minWidth: 460,
			maxWidth: 460
		});
		dialog.bindDestruct(jodit);

		const container = new UiAiAssistant(jodit, {
			onInsertAfter(html: string): void {
				jodit.s.focus();
				jodit.s.setCursorAfter(jodit.s.current()!);
				jodit.s.insertHTML(html);
				dialog.close();
			},
			onInsert(html: string): void {
				jodit.s.focus();
				jodit.s.insertHTML(html);
				dialog.close();
			}
		});

		container.bindDestruct(dialog);
		dialog.open(container, 'AI Assistant', true, false);

		container.setPrompt(prompt);
	}

	@watch(':invokeAiAssistant')
	protected onInvokeAiAssistant(prompt: string): void {
		const { jodit } = this;

		jodit.s.focus();
		const selectedText = jodit.s.html;

		jodit.async
			.promise<string>(async (resolve, reject) => {
				try {
					const result = await jodit.o.aiAssistant
						.aiAssistantCallback!(prompt, selectedText);
					resolve(result);
				} catch (error) {
					reject(error);
				}
			})
			.then((htmlFragment: string) => {
				jodit.e.fire('ai-assistant-response', htmlFragment);
			})
			.catch(error => {
				jodit.message.error(error.message);
				jodit.e.fire('ai-assistant-error', error.message);
			});
	}

	/** @override */
	protected beforeDestruct(_: IJodit): void {}
}

pluginSystem.add('ai-assistant', aiAssistant);
